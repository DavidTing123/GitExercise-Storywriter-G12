<!-- templates/story_page.html -->
<!-- TZX004 : Revise the whole html codes on 20 May 2024 -->
<!-- TZX010 : Add in a new function: Text translation on 4 Jun 2024 -->
<link rel="stylesheet" href="{{ url_for('static', filename='printbutton.css') }}">
{% extends "nav.html" %}

<!-- Roel01 - Changes (start) --------------------------------------------->
<link rel="stylesheet" href="{{ url_for('static', filename='css/review.css') }}">
<!-- Roel01 - Changes (end) --------------------------------------------->

<!-- TZX010 : Add 3 lines below -->
{% block title %}
    Story | Reading
{% endblock %}

{% block content %}

    <!-- TZX010 : 1 line chg below -->
    <h1 class="Text-shadow-1">Story Reading</h1>

    <!-- TZX010 - Changes (begin) --------------------------------------------->
    <div class="grid-container">
        <div class="grid-item-1">
            <!-- TZX013 : Define a print & no-print area (start) ----------------------------->
            <form id="translate-form">
                <div class="print-content"> 
                    <h1 for="text" class="StoryTitle">{{ data.page_title }}</h1>
                    <div id="text" name="text" class="Content-1">    
                        {{ data.html|safe }}
                    </div><br>
                </div>
                
                <div class="no-print" >
                    <p class="Author-TimeStamp"><i><small>&bull; Written by {{ data.author }} on {{ data.timestamp }}</small></i></p>
                    <button id="print-btn">Print Story</button>
                    <br>
                    <audio controls>
                        <source src="{{ url_for('static', filename='Audio1.mp3') }}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    <br><br>
                    <label for="language">Translate text to:</label><br>
                    <select id="language" name="language">
                        {% for code, name in languages.items() %}
                            <option value="{{ code }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Translate</button>
                    <label><small>Note: The translation might take a few seconds to complete.</small></label>
                </div>
            </form>
            <!-- TZX013 : Chg lines above (end) ---------------------------------------------->
        </div>
        
        <div class="grid-item-2">
            <h2 class="Preview-1" >Text Translation</h2>
            <div class="Preview-1" id="translation">
            </div>
            <audio controls id="audio2Player" class="Audio2Player" >
                <source src="{{ url_for('static', filename='Audio2.mp3') }}" type="audio/mpeg">
             <!--   <source src="StoryApp/Audio2.mp3" type="audio/mpeg">  -->
             <!--   <source src="Audio2.mp3" type="audio/mpeg">  -->
                Your browser does not support the audio element.
            </audio>    
        </div>
    </div>
    <!-- TZX010 - Changes (end) --------------------------------------------->

  <!-- TZX013 : Comment 1 line below -->
  <!--  <p class="Author-TimeStamp"><i><small>&bull; Written by {{ data.author }} on {{ data.timestamp }}</small></i></p>  -->

    <!-- Print button -->
 <!--   <button id="print-btn">Print Story</button>  --><!-- Commented by TZX013 -->

    <!-- TZX013 - Changes (begin) --------------------------------------------->
    <div class="no-print" >
        <hr>
        <h2>User Rating (average):  <p id="average_rating"></p></h2>
        <form id="Rating-form">
            <div class="star-rating" id="star-rating">
                <input type="radio" id="5-stars" name="rating" value=5>
                <label for="5-stars" class="star">&#9733;</label>
                <input type="radio" id="4-stars" name="rating" value=4>
                <label for="4-stars" class="star">&#9733;</label>
                <input type="radio" id="3-stars" name="rating" value=3>
                <label for="3-stars" class="star">&#9733;</label>
                <input type="radio" id="2-stars" name="rating" value=2>
                <label for="2-stars" class="star">&#9733;</label>
                <input type="radio" id="1-star" name="rating" value=1>
                <label for="1-star" class="star">&#9733;</label>
            </div>
            <button id="submitRating">Submit Rating</button>
        </form>
        <br>
    </div>
    <!-- TZX013 - Changes (end) --------------------------------------------->

    <script>
         // Function to handle printing
        function printStory() {
             window.print();
           }
   
         // Attach event listener to print button
        document.getElementById('print-btn').addEventListener('click', printStory);
    </script>

    <!-- Comment Section -->

    <!-- Roel02 - Changes (start) --------------------------------------------->
    <div class="bodyy"></div>
    <div class="containerr">
        <form id="comment-form">
            <div class="headd"><h2>Post a Comment</h2></div>
            <div><span id="commentCount">0</span> Comments</div>
            <div class="textt"><p>We are happy to hear from you</p></div><br>
            <label for="username">Your name:</label><br>
            <input type="text" id="username" name="username" required>
            <br>
            <label for="comment">Your comment:</label><br>
            <textarea id="comment" name="comment" rows="4" cols="50" required placeholder="Write your comment here"></textarea>
            <br>
            <button type="button" onclick="submitData()">Publish</button>
            <br>
            <p class="policy">This site is protected by reCAPTCHA and the Google <a href="">privacy policy</a> and <a href="">Terms of Service</a> apply.</p>
            <br>
            <p id="processedData"></p>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Include jQuery for AJAX -->

    <script>
        // TZX010 - Changes (begin) ---------------------------------------------
        // Handling form submission via JavaScript and accessing the text content directly from the DOM element.
        document.getElementById('translate-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const text = document.getElementById('text').textContent;
            const language = document.getElementById('language').value;

            fetch('/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'text': text,
                    'language': language
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('response data:', data);  // Log response data for debugging
                if (data.translation) {
                    document.getElementById('translation').innerText = data.translation;
                    // To refresh the audio element (id=audio2Player) in the HTML.
                    // Force reload of the audio source by appending a query parameter with the current timestamp.
                    // This ensures the browser fetches the new source instead of using a cached version.
                    var audioElement = document.getElementById('audio2Player');
                    audioElement.src = "{{ url_for('static', filename='Audio2.mp3') }}" + "?t=" + new Date().getTime();
                    audioElement.load();                    
                } else {
                    console.error('Translation not found in response');
                }
            })
            .catch(error => console.error('Error:', error));
        });
        // TZX010 - Changes (end) ---------------------------------------------

        // TZX011 - Changes (start) ---------------------------------------------
        function submitRating(storyId) {
            const rating = document.querySelector('input[name="rating"]:checked').value;
            const data = {
                story_id: storyId,
                rating: parseInt(rating)  // Ensure rating is sent as an integer
            };

            fetch('/add_rating', {
                method: 'POST',     // Set method to POST
                headers: {
                    'Content-Type': 'application/json'  // Set Content-Type header
                },
                body: JSON.stringify(data)  // Convert data to JSON string for body
            })
            .then(response => response.json()) // Parse JSON response from server
            .then(data => {
                console.log('Success:', data);
                console.log('response data:', data);        // Log response data for debugging
                document.getElementById("average_rating").textContent = data.average_rating;
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        document.getElementById('submitRating').addEventListener('click', (event) => {
            // Prevent default form submission behavior (if applicable)
            event.preventDefault();

            // Call your submitRating function with story.id
            //submitRating({{ story.id }});
        });

        // TZX011 - Changes (end) ---------------------------------------------

        function submitData() {
            const username = document.getElementById("username").value;
            const comment = document.getElementById("comment").value;

            const data = {
                username: username,
                comment: comment
            };

            fetch('/add_comment', {
                method: 'POST', // Set method to POST
                headers: { 'Content-Type': 'application/json' }, // Set Content-Type header
                body: JSON.stringify(data) // Convert data to JSON string for body
            })
            .then(response => response.json()) // Parse JSON response from server
            .then(data => {
                console.log('Roel02 - For debugging #1');   // Log to console for debugging
                console.log('response data:', data);        // Log response data for debugging
                document.getElementById("processedData").textContent = data.processed_data;
            })
            .catch(error => console.error(error));
        }
        
    </script>
    <!-- Roel02 - Changes (start) --------------------------------------------->


{% endblock content %}